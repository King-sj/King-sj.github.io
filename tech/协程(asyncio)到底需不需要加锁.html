<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.9" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.38" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://github.com/King-sj/tech/%E5%8D%8F%E7%A8%8B(asyncio)%E5%88%B0%E5%BA%95%E9%9C%80%E4%B8%8D%E9%9C%80%E8%A6%81%E5%8A%A0%E9%94%81.html"><meta property="og:site_name" content="blog"><meta property="og:title" content="并发异步编程之争：协程(asyncio)到底需不需要加锁？(线程/协程安全/挂起/主动切换)Python3"><meta property="og:description" content="并发异步编程之争：协程(asyncio)到底需不需要加锁？(线程/协程安全/挂起/主动切换)Python3 头像头像 刘悦的技术博客 2022-03-18 阅读 6 分钟 头图头图 原文转载自「刘悦的技术博客」https://v3u.cn/a_id_208 协程与线程向来焦孟不离，但事实上是，线程更被我们所熟知，在Python编程领域，单核同时间内只能..."><meta property="og:type" content="article"><meta property="og:image" content="https://avatar-static.segmentfault.com/272/694/2726948578-60fd1deec0c0b_huge128"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-10-18T03:49:23.000Z"><meta property="article:author" content="KSJ"><meta property="article:modified_time" content="2024-10-18T03:49:23.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"并发异步编程之争：协程(asyncio)到底需不需要加锁？(线程/协程安全/挂起/主动切换)Python3","image":["https://avatar-static.segmentfault.com/272/694/2726948578-60fd1deec0c0b_huge128","https://segmentfault.com/img/bVcYz7i?spec=cover","https://segmentfault.com/img/remote/1460000041568841"],"dateModified":"2024-10-18T03:49:23.000Z","author":[{"@type":"Person","name":"KSJ","url":"https://github.com/King-sj"}]}</script><title>并发异步编程之争：协程(asyncio)到底需不需要加锁？(线程/协程安全/挂起/主动切换)Python3 | blog</title><meta name="description" content="并发异步编程之争：协程(asyncio)到底需不需要加锁？(线程/协程安全/挂起/主动切换)Python3 头像头像 刘悦的技术博客 2022-03-18 阅读 6 分钟 头图头图 原文转载自「刘悦的技术博客」https://v3u.cn/a_id_208 协程与线程向来焦孟不离，但事实上是，线程更被我们所熟知，在Python编程领域，单核同时间内只能...">
    <link rel="preload" href="/assets/style-CLwVVXQ9.css" as="style"><link rel="stylesheet" href="/assets/style-CLwVVXQ9.css">
    <link rel="modulepreload" href="/assets/app-DP5VP1rc.js"><link rel="modulepreload" href="/assets/协程(asyncio)到底需不需要加锁.html-D5i-Zdi1.js">
    <link rel="prefetch" href="/assets/index.html-D9cQ0Oin.js" as="script"><link rel="prefetch" href="/assets/intro.html-CBPdTNAn.js" as="script"><link rel="prefetch" href="/assets/index.html-Cxt-SBME.js" as="script"><link rel="prefetch" href="/assets/index.html-BJuH77NG.js" as="script"><link rel="prefetch" href="/assets/index.html-CHFFB03I.js" as="script"><link rel="prefetch" href="/assets/Qt6 Maintence tools不能安装Qt5.html-BHG0qgzS.js" as="script"><link rel="prefetch" href="/assets/android studio换源.html-BIq4m6Q2.js" as="script"><link rel="prefetch" href="/assets/cicd.html-w2rGsOPp.js" as="script"><link rel="prefetch" href="/assets/docker_nginx部署web项目.html-ucHkZuhR.js" as="script"><link rel="prefetch" href="/assets/docker.html-CjvocWc0.js" as="script"><link rel="prefetch" href="/assets/github 工作流.html-568hfKgo.js" as="script"><link rel="prefetch" href="/assets/index.html-D23pogmN.js" as="script"><link rel="prefetch" href="/assets/modint.html-DsJgyu_j.js" as="script"><link rel="prefetch" href="/assets/steam模组开发.html-DAMKFaOe.js" as="script"><link rel="prefetch" href="/assets/style.html-DnpX13Uv.js" as="script"><link rel="prefetch" href="/assets/vsocde插件开发小记.html-DcKDCUzz.js" as="script"><link rel="prefetch" href="/assets/「算术公理系统 1」自然数.html-BCX-iJoj.js" as="script"><link rel="prefetch" href="/assets/使用capacitor和ionic将vue项目迁移到mobile端.html-Ba1LJiec.js" as="script"><link rel="prefetch" href="/assets/协程.html-77Tvoecd.js" as="script"><link rel="prefetch" href="/assets/程序员的PPT.html-DHTK710r.js" as="script"><link rel="prefetch" href="/assets/闭包实现类.html-VmxoHi91.js" as="script"><link rel="prefetch" href="/assets/index.html-BDMMzlHB.js" as="script"><link rel="prefetch" href="/assets/0.html-DNwcSnBG.js" as="script"><link rel="prefetch" href="/assets/1.html-BnS2GCrh.js" as="script"><link rel="prefetch" href="/assets/2.html-DqKEL6xw.js" as="script"><link rel="prefetch" href="/assets/3.html-DA68fDuY.js" as="script"><link rel="prefetch" href="/assets/4.html-Ce7dm0_-.js" as="script"><link rel="prefetch" href="/assets/5.html-CkOLqTbt.js" as="script"><link rel="prefetch" href="/assets/6.html-CVusQeDG.js" as="script"><link rel="prefetch" href="/assets/7.html-D7nOQob4.js" as="script"><link rel="prefetch" href="/assets/8.html-DFz0Y30_.js" as="script"><link rel="prefetch" href="/assets/9.html-oW2nJjKT.js" as="script"><link rel="prefetch" href="/assets/404.html-BGz3f4WB.js" as="script"><link rel="prefetch" href="/assets/index.html-BUGuWQ0O.js" as="script"><link rel="prefetch" href="/assets/index.html-BT_TRij6.js" as="script"><link rel="prefetch" href="/assets/index.html-COFLcrMY.js" as="script"><link rel="prefetch" href="/assets/index.html-BKC0GXYj.js" as="script"><link rel="prefetch" href="/assets/index.html-C6kA8o1a.js" as="script"><link rel="prefetch" href="/assets/index.html-BL5X-lGl.js" as="script"><link rel="prefetch" href="/assets/index.html-CNIGHF5i.js" as="script"><link rel="prefetch" href="/assets/index.html-DSs3G_hE.js" as="script"><link rel="prefetch" href="/assets/index.html-B8lUTqM0.js" as="script"><link rel="prefetch" href="/assets/index.html-0Tl5GbBU.js" as="script"><link rel="prefetch" href="/assets/index.html-0GHwfEgE.js" as="script"><link rel="prefetch" href="/assets/index.html-fzmad5ay.js" as="script"><link rel="prefetch" href="/assets/index.html-DcuO1mSo.js" as="script"><link rel="prefetch" href="/assets/index.html-BO3-IaLI.js" as="script"><link rel="prefetch" href="/assets/index.html-BfCynv2K.js" as="script"><link rel="prefetch" href="/assets/index.html-CxH0BQ9P.js" as="script"><link rel="prefetch" href="/assets/index.html-K29PkD_C.js" as="script"><link rel="prefetch" href="/assets/index.html-DUN4M98M.js" as="script"><link rel="prefetch" href="/assets/index.html-BF9zX4xD.js" as="script"><link rel="prefetch" href="/assets/index.html-D1Aiy0-m.js" as="script"><link rel="prefetch" href="/assets/index.html-DnEcnpOx.js" as="script"><link rel="prefetch" href="/assets/giscus--_FS5kYt.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-SzV8tJDW.js" as="script"><link rel="prefetch" href="/assets/SearchResult-DidhDvPg.js" as="script"><link rel="prefetch" href="/assets/index-BNnYFWcz.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="/logo.svg" alt><!----><span class="vp-site-name hide-in-pad">blog</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link" href="/" aria-label="home"><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span>home<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link active" href="/tech/" aria-label="技术"><!---->技术<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link" href="/essays/" aria-label="随笔"><!---->随笔<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link" href="/projects/" aria-label="项目"><!---->项目<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link" href="/tutorials/" aria-label="教程"><!---->教程<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link" href="/resources/" aria-label="资源"><!---->资源<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/King-sj/KBlog" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">搜索</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">技术</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/tech/modint.html" aria-label="「泛型与 OI」modint"><!---->「泛型与 OI」modint<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/tech/%E3%80%8C%E7%AE%97%E6%9C%AF%E5%85%AC%E7%90%86%E7%B3%BB%E7%BB%9F%201%E3%80%8D%E8%87%AA%E7%84%B6%E6%95%B0.html" aria-label="「算术公理系统 1」自然数"><!---->「算术公理系统 1」自然数<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/tech/android%20studio%E6%8D%A2%E6%BA%90.html" aria-label="android studio换源"><!---->android studio换源<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/tech/cicd.html" aria-label="CI/CD"><!---->CI/CD<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Design ASimpile CCompiler</span><span class="vp-arrow end"></span></button><!----></section></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/tech/docker_nginx%E9%83%A8%E7%BD%B2web%E9%A1%B9%E7%9B%AE.html" aria-label="docker + nginx + acme.sh 部署 vue/flask 项目"><!---->docker + nginx + acme.sh 部署 vue/flask 项目<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/tech/docker.html" aria-label="docker in wsl"><!---->docker in wsl<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/tech/steam%E6%A8%A1%E7%BB%84%E5%BC%80%E5%8F%91.html" aria-label="Game Plugin"><!---->Game Plugin<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/tech/github%20%E5%B7%A5%E4%BD%9C%E6%B5%81.html" aria-label="github 工作流程"><!---->github 工作流程<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/tech/Qt6%20Maintence%20tools%E4%B8%8D%E8%83%BD%E5%AE%89%E8%A3%85Qt5.html" aria-label="Qt"><!---->Qt<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/tech/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84PPT.html" aria-label="Slidev"><!---->Slidev<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/tech/vsocde%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%E5%B0%8F%E8%AE%B0.html" aria-label="vscode plugin"><!---->vscode plugin<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/tech/%E4%BD%BF%E7%94%A8capacitor%E5%92%8Cionic%E5%B0%86vue%E9%A1%B9%E7%9B%AE%E8%BF%81%E7%A7%BB%E5%88%B0mobile%E7%AB%AF.html" aria-label="使用capacitor和ionic将vue项目迁移到mobile端"><!---->使用capacitor和ionic将vue项目迁移到mobile端<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/tech/%E5%8D%8F%E7%A8%8B.html" aria-label="协程"><!---->协程<!----></a></li><li><a class="route-link nav-link active vp-sidebar-link vp-sidebar-page active" href="/tech/%E5%8D%8F%E7%A8%8B(asyncio)%E5%88%B0%E5%BA%95%E9%9C%80%E4%B8%8D%E9%9C%80%E8%A6%81%E5%8A%A0%E9%94%81.html" aria-label="并发异步编程之争：协程(asyncio)到底需不需要加锁？(线程/协程安全/挂起/主动切换)Python3"><!---->并发异步编程之争：协程(asyncio)到底需不需要加锁？(线程/协程安全/挂起/主动切换)Python3<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/tech/" aria-label="技术"><!---->技术<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/tech/%E9%97%AD%E5%8C%85%E5%AE%9E%E7%8E%B0%E7%B1%BB.html" aria-label="闭包实现类"><!---->闭包实现类<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/tech/style.html" aria-label="风格统一"><!---->风格统一<!----></a></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->并发异步编程之争：协程(asyncio)到底需不需要加锁？(线程/协程安全/挂起/主动切换)Python3</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://github.com/King-sj" target="_blank" rel="noopener noreferrer">KSJ</a></span><span property="author" content="KSJ"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-10-18T03:49:23.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 10 分钟</span><meta property="timeRequired" content="PT10M"></span><!----><!----></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!--[--><!----><!--]--><div class="vp-toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#线程安全">线程安全</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#协程">协程</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#协程安全">协程安全</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#协程是否需要加锁">协程是否需要加锁</a></li><!----><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!--[--><!----><!--]--><div class="theme-hope-content"><h1 id="并发异步编程之争-协程-asyncio-到底需不需要加锁-线程-协程安全-挂起-主动切换-python3" tabindex="-1"><a class="header-anchor" href="#并发异步编程之争-协程-asyncio-到底需不需要加锁-线程-协程安全-挂起-主动切换-python3"><span><a href="https://segmentfault.com/a/1190000041568839" target="_blank" rel="noopener noreferrer">并发异步编程之争：协程(asyncio)到底需不需要加锁？(线程/协程安全/挂起/主动切换)Python3<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></span></a></h1><figure><img src="https://avatar-static.segmentfault.com/272/694/2726948578-60fd1deec0c0b_huge128" alt="头像" tabindex="0" loading="lazy"><figcaption>头像</figcaption></figure><p><strong>刘悦的技术博客</strong></p><p><a href="https://segmentfault.com/a/1190000041568839/revision" target="_blank" rel="noopener noreferrer">2022-03-18<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>阅读 6 分钟</p><figure><img src="https://segmentfault.com/img/bVcYz7i?spec=cover" alt="头图" tabindex="0" loading="lazy"><figcaption>头图</figcaption></figure><p>原文转载自「刘悦的技术博客」<a href="https://link.segmentfault.com/?enc=8btt3pfGP%2FRxuxLguNqhrg%3D%3D.f%2BWWJlm9AsMAbAJjJZT%2BOQBqYNXwZgTYGW7Jx9l%2BpxQ%3D" target="_blank" rel="noopener noreferrer">https://v3u.cn/a_id_208<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>协程与线程向来焦孟不离，但事实上是，线程更被我们所熟知，在Python编程领域，单核同时间内只能有一个线程运行，这并不是什么缺陷，这实际上是符合客观逻辑的，单核处理器本来就没法同时处理两件事情，要同时进行多件事情本来就需要正在运行的让出处理器，然后才能去处理另一件事情，左手画方右手画圆在现实中本来就不成立，只不过这个让出的过程是线程调度器主动抢占的。</p><h2 id="线程安全" tabindex="-1"><a class="header-anchor" href="#线程安全"><span>线程安全</span></a></h2><p>系统的线程调度器是假设不同的线程是毫无关系的，所以它平均地分配时间片让处理器一视同仁，雨露均沾。但是Python受限于GIL全局解释器锁，任何Python线程执行前，必须先获得GIL锁，然后，每执行100条字节码，解释器就自动释放GIL锁，让别的线程有机会执行。这个GIL全局解释器锁实际上把所有线程的执行代码都给上了锁，所以，多线程在Python中只能交替执行，即使多个线程跑在8核处理上，也只能用到1个核。</p><p>但其实，这并不是事情的全貌，就算只能用单核处理任务，多个线程之前也并不是完全独立的，它们会操作同一个资源。于是，大家又发明了同步锁，使得一段时间内只有一个线程可以操作这个资源，其他线程只能等待：</p><div class="language-mipsasm line-numbers-mode" data-ext="mipsasm" data-title="mipsasm"><pre class="language-mipsasm"><code>import threading

balance = 0

def change_it_without_lock(n):
    global balance
    # 不加锁的话 最后的值不是0
    # 线程共享数据危险在于 多个线程同时改同一个变量
    # 如果每个线程按顺序执行，那么值会是0， 但是线程时系统调度，又不确定性，交替进行
    # 没锁的话，同时修改变量
    # 所以加锁是为了同时只有一个线程再修改，别的线程表一定不能改
    for i in range(1000000):
        balance = balance + n
        balance = balance - n

def change_it_with_lock(n):
    global balance
    if lock.acquire():
        try:
            for i in range(1000000):
                balance = balance + n
                balance = balance - n
        # 这里的finally 防止中途出错了，也能释放锁
        finally:
            lock.release()

threads = [
    threading.Thread(target=change_it_with_lock, args=(8, )),
    threading.Thread(target=change_it_with_lock, args=(10, ))
]

lock = threading.Lock()

[t.start() for t in threads]
[t.join() for t in threads]

print(balance)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这种异步编程方式被广大开发者所认可，线程并不安全，线程操作共享资源需要加锁。然而人们很快发现，这种处理方式是在画蛇添足，处理器本来同一时间就只能有一个线程在运行。是线程调度器抢占划分时间片给其他线程跑，而现在，多了把锁，其他线程又说我拿不到锁，我得拿到锁才能操作。</p><p>就像以前的公共电话亭，本来就只能一个人打电话，现在电话亭上加了把锁，还是只能一个人打电话，而有没有锁，有什么区别呢？所以，问题到底出在哪儿？</p><p>事实上，在所有线程相互独立且不会操作同一资源的模式下，抢占式的线程调度器是非常不错的选择，因为它可以保证所有的线程都可以被分到时间片不被垃圾代码所拖累。而如果操作同一资源，抢占式的线程就不那么让人愉快了。</p><h2 id="协程" tabindex="-1"><a class="header-anchor" href="#协程"><span>协程</span></a></h2><p>过了一段时间，人们发现经常需要异步操作共享资源的情况下，主动让出时间片的协程模式比线程抢占式分配的效率要好，也更简单。</p><p>从实际开发角度看，与线程相比，这种主动让出型的调度方式更为高效。一方面，它让调用者自己来决定什么时候让出，比操作系统的抢占式调度所需要的时间代价要小很多。后者为了能恢复现场会在切换线程时保存相当多的状态，并且会非常频繁地进行切换。另一方面，协程本身可以做成用户态，每个协程的体积比线程要小得多，因此一个进程可以容纳数量相当可观的协程任务。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">asyncio</span>

balance <span class="token operator">=</span> <span class="token number">0</span>

async def <span class="token function">change_it_without_lock</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token operator">:</span>

    global balance

    balance <span class="token operator">=</span> balance <span class="token operator">+</span> n
    balance <span class="token operator">=</span> balance <span class="token operator">-</span> n


loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span><span class="token function">get_event_loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

res <span class="token operator">=</span> loop<span class="token punctuation">.</span><span class="token function">run_until_complete</span><span class="token punctuation">(</span>
    asyncio<span class="token punctuation">.</span><span class="token function">gather</span><span class="token punctuation">(</span><span class="token function">change_it_without_lock</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">change_it_without_lock</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   <span class="token function">change_it_without_lock</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">change_it_without_lock</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token function">print</span><span class="token punctuation">(</span>balance<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从代码结构上看，协程保证了编写过程中的思维连贯性，使得函数（闭包）体本身就无缝保持了程序状态。逻辑紧凑，可读性高，不易写出错的代码，可调试性强。</p><p>但归根结底，单核处理器还是同时间只能做一件事，所以同一时间点还是只能有一个协程任务运行，它和线程的最主要差别就是，协程是主动让出使用权，而线程是抢占使用权，即所谓的，协程是用户态，线程是系统态。</p><figure><img src="https://segmentfault.com/img/remote/1460000041568841" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>同时，如图所示，协程本身就是单线程的，即不会触发系统的全局解释器锁(GIL)，同时也不需要系统的线程调度器参与抢占式的调度，避免了多线程的上下文切换，所以它的性能要比多线程好。</p><h2 id="协程安全" tabindex="-1"><a class="header-anchor" href="#协程安全"><span>协程安全</span></a></h2><p>回到并发竞争带来的安全问题上，既然同一时间只能有一个协程任务运行，并且协程切换并不是系统态抢占式，那么协程一定是安全的：</p><div class="language-gauss line-numbers-mode" data-ext="gauss" data-title="gauss"><pre class="language-gauss"><code>import asyncio

balance = 0

async def change_it_without_lock(n):

    global balance

    balance = balance + n
    balance = balance - n

    print(balance)


loop = asyncio.get_event_loop()

res = loop.run_until_complete(
    asyncio.gather(change_it_without_lock(10), change_it_without_lock(8),
                   change_it_without_lock(2), change_it_without_lock(7)))

print(balance)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行结果：</p><div class="language-crmsh line-numbers-mode" data-ext="crmsh" data-title="crmsh"><pre class="language-crmsh"><code>0
0
0
0
0
liuyue:as-master liuyue$
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>看起来是这样的，无论是执行过程中，还是最后执行结果，都保证了其状态的一致性。</p><p>于是，协程操作共享变量不需要加锁的结论开始在坊间流传。</p><p>毫无疑问，谁主张，谁举证，上面的代码也充分说明了这个结论的正确性，然而我们都忽略了一个客观事实，那就是代码中没有“主动让出使用权”的操作，所谓主动让出使用权，即用户主动触发协程切换，那到底怎么主动让出使用权？使用 await 关键字。</p><p>await 是 Python 3.5版本开始引入了新的关键字，即Python3.4版本的yield from，它能做什么？它可以在协程内部用await调用另一个协程实现异步操作，或者说的更简单一点，它可以挂起当前协程任务，去手动异步执行另一个协程，这就是主动让出“使用权”：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Hello world!&quot;</span><span class="token punctuation">)</span>
    r <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Hello again!&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当我们执行第一句代码print(&quot;Hello world!&quot;)之后，使用await关键字让出使用权，也可以理解为把程序“暂时”挂起，此时使用权让出以后，别的协程就可以进行执行，随后当我们让出使用权1秒之后，当别的协程任务执行完毕，又或者别的协程任务也“主动”让出了使用权，协程又可以切回来，继续执行我们当前的任务，也就是第二行代码print(&quot;Hello again!&quot;)。</p><p>了解了协程如何主动切换，让我们继续之前的逻辑：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">import</span> asyncio

balance <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">change_it_without_lock</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">global</span> balance

    balance <span class="token operator">=</span> balance <span class="token operator">+</span> n
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    balance <span class="token operator">=</span> balance <span class="token operator">-</span> n

    <span class="token keyword">print</span><span class="token punctuation">(</span>balance<span class="token punctuation">)</span>


loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>

res <span class="token operator">=</span> loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>
    asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>change_it_without_lock<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> change_it_without_lock<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   change_it_without_lock<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> change_it_without_lock<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>balance<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>逻辑有了些许修改，当我对全局变量balance进行加法运算后，主动释放使用权，让别的协程运行，随后立刻切换回来，再进行减法运算，如此往复，同时开启四个协程任务，让我们来看一下代码运行结果：</p><div class="language-avrasm line-numbers-mode" data-ext="avrasm" data-title="avrasm"><pre class="language-avrasm"><code>17
9
7
0
0
liuyue:mytornado liuyue$
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，协程运行过程中，并没有保证“状态一致”，也就是一旦通过await关键字切换协程，变量的状态并不会进行同步，从而导致执行过程中变量状态的“混乱状态”，但是所有协程执行完毕后，变量balance的最终结果是0，意味着协程操作变量的最终一致性是可以保证的。</p><p>为了对比，我们再用多线程试一下同样的逻辑：</p><div class="language-routeros line-numbers-mode" data-ext="routeros" data-title="routeros"><pre class="language-routeros"><code>import threading
import time

balance = 0

def change_it_without_lock(n):
    global balance

    for i in range(1000000):
        balance = balance + n
        balance = balance - n

    print(balance)


threads = [
    threading.Thread(target=change_it_without_lock, args=(8, )),
    threading.Thread(target=change_it_without_lock, args=(10, )),
    threading.Thread(target=change_it_without_lock, args=(10, )),
    threading.Thread(target=change_it_without_lock, args=(8, ))
]

[t.start() for t in threads]
[t.join() for t in threads]

print(balance)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>多线程逻辑执行结果：</p><div class="language-avrasm line-numbers-mode" data-ext="avrasm" data-title="avrasm"><pre class="language-avrasm"><code>liuyue:mytornado liuyue$ python3 &quot;/Users/liuyue/wodfan/work/mytornado/test.py&quot;
28
18
10
0
8
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，多线程在未加锁的情况下，连最终一致性也无法保证，因为线程是系统态切换，虽然同时只能有一个线程执行，但切换过程是争抢的，也就会导致写操作被原子性覆盖，而协程虽然在手动切换过程中也无法保证状态一致，但是可以保证最终一致性呢？因为协程是用户态，切换过程是协作的，所以写操作不会被争抢覆盖，会被顺序执行，所以肯定可以保证最终一致性。</p><p>协程在工作状态中，主动切换了使用权，而我们又想在执行过程中保证共享数据的强一致性，该怎么办？毫无疑问，还是只能加锁：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">import</span> asyncio

balance <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">change_it_with_lock</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">async</span> <span class="token keyword">with</span> lock<span class="token punctuation">:</span>

        <span class="token keyword">global</span> balance

        balance <span class="token operator">=</span> balance <span class="token operator">+</span> n
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        balance <span class="token operator">=</span> balance <span class="token operator">-</span> n

        <span class="token keyword">print</span><span class="token punctuation">(</span>balance<span class="token punctuation">)</span>


lock <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>


loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>

res <span class="token operator">=</span> loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>
    asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>change_it_with_lock<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> change_it_with_lock<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   change_it_with_lock<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> change_it_with_lock<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>balance<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>协程加锁执行后结果：</p><div class="language-avrasm line-numbers-mode" data-ext="avrasm" data-title="avrasm"><pre class="language-avrasm"><code>liuyue:mytornado liuyue$ python3 &quot;/Users/liuyue/wodfan/work/mytornado/test.py&quot;
0
0
0
0
0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>是的，无论是结果，还是过程中，都保持了其一致性，但是我们也付出了相应的代价，那就是任务又回到了线性同步执行，再也没有异步的加持了。话说回来，世界上的事情本来就是这样，本来就没有两全其美的解决方案，又要共享状态，又想多协程，还想变量安全，这可能吗？</p><h2 id="协程是否需要加锁" tabindex="-1"><a class="header-anchor" href="#协程是否需要加锁"><span>协程是否需要加锁</span></a></h2><p>结论当然就是看使用场景，如果协程在操作共享变量的过程中，没有主动放弃执行权(await)，也就是没有切换挂起状态，那就不需要加锁，执行过程本身就是安全的；可是如果在执行事务逻辑块中主动放弃执行权了，会分两种情况，如果在逻辑执行过程中我们需要判断变量状态，或者执行过程中要根据变量状态进行一些下游操作，则必须加锁，如果我们不关注执行过程中的状态，只关注最终结果一致性，则不需要加锁。是的，抛开剂量谈毒性，是不客观的，给一个健康的人注射吗啡是犯罪，但是给一个垂死的人注射吗啡，那就是最大的道德，所以说，道德不是空泛的，脱离对象孤立存在的，同理，抛开场景谈逻辑，也是不客观的，协程也不是虚空的，脱离具体场景孤立存在的，我们应该养成具体问题具体分析的辩证唯物思想，只有掌握了辩证的矛盾思维才能更全面更灵活的看待问题，才能透过现象，把握本质。</p><p>原文转载自「刘悦的技术博客」 <a href="https://link.segmentfault.com/?enc=aOuNWC7a1JCzFai3ycjkKg%3D%3D.l5t0sKltIhLGYnZPLxsFYIiEbKuxzYikfYFHmurPNGM%3D" target="_blank" rel="noopener noreferrer">https://v3u.cn/a_id_208<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><!--[--><!----><!--]--><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a href="https://github.com/King-sj/KBlog/edit/main/src/tech/协程(asyncio)到底需不需要加锁.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页" class="nav-link vp-meta-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">上次编辑于: </span><!----></div><div class="contributors"><span class="vp-meta-label">贡献者: </span><!--[--><!--[--><span class="vp-meta-info" title="email: 2175616761@qq.com">King</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link nav-link prev" href="/tech/%E5%8D%8F%E7%A8%8B.html" aria-label="协程"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->协程</div></a><a class="route-link nav-link active next" href="/tech/" aria-label="技术"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">技术<!----></div></a></nav><div id="vp-comment" class="giscus-wrapper input-top" style="display:block;"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" preserveAspectRatio="xMidYMid" viewBox="0 0 100 100"><circle cx="28" cy="75" r="11" fill="currentColor"><animate attributeName="fill-opacity" begin="0s" dur="1s" keyTimes="0;0.2;1" repeatCount="indefinite" values="0;1;1"></animate></circle><path fill="none" stroke="#88baf0" stroke-width="10" d="M28 47a28 28 0 0 1 28 28"><animate attributeName="stroke-opacity" begin="0.1s" dur="1s" keyTimes="0;0.2;1" repeatCount="indefinite" values="0;1;1"></animate></path><path fill="none" stroke="#88baf0" stroke-width="10" d="M28 25a50 50 0 0 1 50 50"><animate attributeName="stroke-opacity" begin="0.2s" dur="1s" keyTimes="0;0.2;1" repeatCount="indefinite" values="0;1;1"></animate></path></svg></div><!--[--><!----><!--]--><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer"><a href='https://beian.miit.gov.cn'>黔ICP备2024025117号-1</a> | 版权所有 © 2024-至今 KSJ </div><div class="vp-copyright">MPL-2.0 许可证</div></footer></div><!--]--><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-DP5VP1rc.js" defer></script>
  </body>
</html>
